
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>LokiCordova — Examples</title>
    <script src="LokiCordova.min.js?v=1.0.0"></script>
    <link rel="stylesheet" href="examples_files/examples.css">
</head>
<body>
    <script>
        localStorage.clear();
        function logOutBuilder(output_el){
            return function(output, append= true){
                const prev= append ? output_el.innerText : "";
                if(typeof output==="string") return (output_el.innerText= prev+output);
                const output_text=
                    Object.keys(output)
                    .map(key=> `"${key}": `+JSON.stringify(output[key], (key, value)=> value===undefined?null:value, '  '))
                    .join("\n\n");
                return (output_el.innerText= prev+output_text+"\n\n");
            };
        }
        function test(input, target){
            const output= Object.keys(input)
            .map(key=> [ key, JSON.stringify(input[key]===target) ])
            .filter(([ , test_success ])=> !test_success);
            
            return output.length ? console.error(`Tyto testy selhali: ${output.map(([key])=> key).join(", ")}`) : console.log("Test proběhl úspěšně");
        }
    </script>
    <article>
        <h1>LokiCordova — Examples</h1>
        <a href="https://github.com/IndigoMultimediaTeam/LokiCordova#readme">⇠ Go back to GitHub repository</a>

        <h2>Ukázka a test joinování</h2>
        <p></p>
        <pre class="output"></pre>
        <script contenteditable="">
            (function(){
                const logOut= logOutBuilder(document.currentScript.previousElementSibling);
        
                LokiCordova.database_({
                    db_file: { file: "test1" },
                    tables: [ "users", "notes" ],
                    auto_cordova_adapter: false
                })
                .then(function({ db, db_utils, tb }){
                    logOut("", false);
        
                    tb.users.insert([
                        { id: 1, name: "Jan" },
                        { id: 2, name: "Ivana" },
                        { id: 3, name: "Peter" },
                        { id: 4, name: "Amanda" },
                        { id: 5, name: "Thor" },
                        { id: 6, name: "Adéla" }
                    ]);
                    tb.notes.insert([
                        { id: 1, id_user: 1, text: "1-1" },
                        { id: 2, id_user: 1, text: "2-1" },
                        { id: 3, id_user: 2, text: "3-2" },
                        { id: 4, id_user: 9, text: "4-9" },
                        { id: 5, id_user: 8, text: "5-8" }
                    ]);
                    db.saveDatabase();
        
                    let join_params, joinMapData;
                    
                    join_params= { data: tb.users, left_key: "id_user", right_key: "id" };
                    joinMapData= ({ left: { text }, right: { name } })=> ({ name, text });
                    const notes_left_join=
                        tb.notes
                        .chain(db_utils.left_join, join_params)
                        .data()
                        .map(joinMapData);
                    const notes_left_join_strict=
                        tb.notes
                        .chain(db_utils.left_join_strict, join_params)
                        .data()
                        .map(joinMapData);
        
                    logOut({ notes_left_join, notes_left_join_strict });
                    
                    join_params= { data: tb.notes, left_key: "id", right_key: "id_user" };
                    joinMapData= ({ left: { name }, right: { text } })=> ({ name, text });
                    const users_left_join=
                        tb.users
                        .chain(db_utils.left_join, join_params)
                        .data()
                        .map(joinMapData);
                    const users_left_join_strict=
                        tb.users
                        .chain(db_utils.left_join_strict, join_params)
                        .data()
                        .map(joinMapData);
                    
                    logOut({ users_left_join, users_left_join_strict });
        
                    /*····················TESTS····················*/
        
                    test({ notes_left_join, notes_left_join_strict, users_left_join, users_left_join_strict },
                        {
                            notes_left_join: '[{"name":"Jan","text":"1-1"},{"name":"Jan","text":"2-1"},{"name":"Ivana","text":"3-2"},{"text":"4-9"},{"text":"5-8"}]',
                            notes_left_join_strict: '[{"name":"Ivana","text":"3-2"},{"name":"Jan","text":"2-1"},{"name":"Jan","text":"1-1"}]',
                            users_left_join: '[{"name":"Jan","text":"2-1"},{"name":"Ivana","text":"3-2"},{"name":"Peter"},{"name":"Amanda"},{"name":"Thor"},{"name":"Adéla"}]',
                            users_left_join_strict: '[{"name":"Ivana","text":"3-2"},{"name":"Jan","text":"2-1"}]'
                        }
                    );
                });
            })();
        </script>
        <h2>Ukázka a test insert/update funkce `upsert` (vloží/aktualizuje záznam)</h2>
        <p></p>
        <pre class="output"></pre>
        <script contenteditable="">
            (function(){
                const logOut= logOutBuilder(document.currentScript.previousElementSibling);
        
                LokiCordova.database_({
                    db_file: { file: "test2" },
                    tables: [ "users" ],
                    auto_cordova_adapter: false
                })
                .then(function({ db, db_utils, tb }){
                    logOut("", false);
        
                    db_utils.upsertByQuery(tb.users, { id: 1, name: "Jan" }, { id: 1 });
                    db_utils.upsertByQuery(tb.users, { surname: "Andrle" }, { id: 1 });
                    
                    db_utils.upsertByKey(tb.users, { id: 2, name: "Anna" });
                    db_utils.upsertByKey(tb.users, { id: 2, surname: "Nová" });
        
                    tb.users.insert({ id: 3, name: "Petra" });
                    db_utils.upsertByUnique(tb.users, { $loki: 3, surname: "Vymyšlená" }, "$loki");
        
                    tb.users.insert({ id: 4, name: "Lukáš" });
                    const update= db_utils.upsertByCallbacks(
                        tb.users,
                        Object.assign,
                        (c, { id })=> c.findOne({ id })
                    );
                    update({ id: 4, surname: "Zimmerman" });
        
                    const users= tb.users.data.map(({ $loki, id, name, surname })=> ({ $loki, id, name, surname }));
                    logOut({ users });
        
                    /*····················TESTS····················*/
        
                    test({ users },
                        {
                            users: '[{"$loki":1,"id":1,"name":"Jan","surname":"Andrle"},{"$loki":2,"id":2,"name":"Anna","surname":"Nová"},{"$loki":3,"id":3,"name":"Petra","surname":"Vymyšlená"},{"$loki":4,"id":4,"name":"Lukáš","surname":"Zimmerman"}]'
                        }
                    );
                });
            })();
        </script>
        <h2>Ukázka a test `save_`</h2>
        <p></p>
        <pre class="output"></pre>
        <script contenteditable="">
            (function(){
                const logOut= logOutBuilder(document.currentScript.previousElementSibling);
                let prev;
        
                LokiCordova.database_({
                    db_file: { file: "test3" },
                    tables: [ "users" ],
                    auto_cordova_adapter: false
                })
                .then(function({ db, db_utils, tb }){
                    logOut("", false);
                    prev= localStorage.getItem("test3");
        
                    tb.users.insert([
                        { id: 1, name: "Jan", surname: "Andrle" },
                        { id: 2, name: "Anna", surname: "Nová" }
                    ]);
                    return db_utils.save_(db);
                })
                .then(function(){
                    const current= localStorage.getItem("test3");
                    return prev!==current ? console.log("Test proběhl úspěšně") : console.error("`test3`: Test proběhl neúspěšně");
                });
            })();
        </script>
    </article>
</body>
</html>